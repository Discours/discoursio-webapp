---
import { Root } from '../components/Root'
import Prerendered from '../main.astro'
import { apiClient } from '../utils/apiClient'
import { initRouter } from '../stores/router'

const slug = Astro.params.slug?.toString()

const article = await apiClient.getShout(slug)
if (!article) {
  return Astro.redirect('/404')
}

const { pathname, search } = Astro.url
initRouter(pathname, search)

Astro.response.headers.set('Cache-Control', 's-maxage=1, stale-while-revalidate')

const title = article.title
const imageUrl = article.cover
const descriptionWordsArray = article.body.substring(0, 150).replaceAll(/<[^>]*>/g, "").split(' ')
const description = descriptionWordsArray.splice(0, descriptionWordsArray.length-1).join(' ') + '...'
---

<Prerendered
  title={title}
  imageUrl={imageUrl}
  description={description}
>
  <Root article={article} client:load />
</Prerendered>
